\\nconst setupLessons = async () => {\\n\\n    // --- CONTROLLO FUNZIONI GLOBALI ---\\n    if (!window.db || !window.model || !firebase.auth().currentUser) {\\n        console.error('Requisiti non soddisfatti: Firestore, AI Model o Utente non autenticato.');\\n        document.getElementById('lesson-result-container').innerHTML = \\n            '<p class=\"error-message\">Errore: Impossibile inizializzare il modulo Lezioni. L\\'assistente AI non è disponibile o non sei autenticato.</p>';\\n        return;\\n    }\\n\\n    // --- RIFERIMENTI FIREBASE ---\\n    const userId = firebase.auth().currentUser.uid;\\n    const classesRef = db.collection('users').doc(userId).collection('classes');\\n\\n    // --- ELEMENTI DEL DOM ---\\n    const form = document.getElementById('lesson-generator-form');\\n    const topicInput = document.getElementById('lesson-topic-input');\\n    const typeSelect = document.getElementById('lesson-type-select');\\n    const classSelect = document.getElementById('lesson-class-select');\\n    const durationInput = document.getElementById('lesson-duration-input');\\n    const detailsTextarea = document.getElementById('lesson-details-textarea');\\n    const generateBtn = document.getElementById('generate-lesson-btn');\\n    const resultContainer = document.getElementById('lesson-result-container');\\n    const resultPlaceholder = document.getElementById('lesson-result-placeholder');\\n    const resultContent = document.getElementById('lesson-result-content');\\n    const resultLoader = document.getElementById('lesson-result-loader');\\n\\n    // --- FUNZIONI ---\\n\\n    const populateClasses = async () => {\\n        try {\\n            const snapshot = await classesRef.orderBy('name').get();\\n            classSelect.innerHTML = '<option value=\"\">Nessuna (generico)</option>';\\n            if (snapshot.empty) return;\\n            snapshot.forEach(doc => {\\n                const option = document.createElement('option');\\n                option.value = doc.data().name; // Usiamo il nome per passarlo all'IA\\n                option.textContent = doc.data().name;\\n                classSelect.appendChild(option);\\n            });\\n        } catch (error) {\\n            console.error(\"Errore nel caricare le classi: \", error);\\n        }\\n    };\\n\\n    const handleGeneration = async (e) => {\\n        e.preventDefault();\\n        \\n        const topic = topicInput.value.trim();\\n        const type = typeSelect.value;\\n        const className = classSelect.value;\\n        const duration = durationInput.value;\\n        const details = detailsTextarea.value.trim();\\n\\n        if (!topic) {\\n            alert(\"Per favore, inserisci un argomento principale.\");\\n            return;\\n        }\\n\\n        resultPlaceholder.style.display = 'none';\\n        resultContent.style.display = 'none';\\n        resultLoader.style.display = 'block';\\n        generateBtn.disabled = true;\\n\\n        let prompt = `Agisci come un assistente esperto per un insegnante di scuola secondaria in Italia. Genera il seguente contenuto in formato Markdown:\\n\\n- **Tipo di Contenuto**: ${document.querySelector(`#lesson-type-select option[value=\"${type}\"]`).textContent}\\n- **Argomento**: ${topic}\\n`;\\n\\n        if (className) prompt += `- **Classe di Riferimento**: ${className}\\n`;\\n        if (duration) prompt += `- **Durata Stimata**: ${duration} minuti\\n`;\\n        if (details) prompt += `- **Dettagli Aggiuntivi**: ${details}\\n`;\\n\\n        prompt += `\\nRispondi in italiano. Fornisci una risposta ben strutturata, chiara, e pronta per l'uso. Utilizza la formattazione Markdown (es. \`## Titolo\`, \`* testo in grassetto\`, \`- elenco puntato\`).`;\\n        \\n        try {\\n            const result = await window.model.generateContent(prompt);\\n            const response = await result.response;\\n            const text = await response.text();\\n\\n            // Usa una libreria esterna se disponibile, altrimenti fallback\\n            if (window.showdown) {\\n                const converter = new showdown.Converter();\\n                resultContent.innerHTML = converter.makeHtml(text);\\n            } else {\\n                resultContent.innerHTML = text.replace(/\\n/g, '<br>'); // Fallback molto semplice\\n            }\\n            resultContent.style.display = 'block';\\n\\n        } catch (error) {\\n            console.error(\"Errore durante la generazione del contenuto:\", error);\\n            resultContent.innerHTML = '<p class=\"error-message\">Si è verificato un errore durante la comunicazione con il servizio AI. Riprova.</p>';\\n            resultContent.style.display = 'block';\\n        } finally {\\n            resultLoader.style.display = 'none';\\n            generateBtn.disabled = false;\\n        }\\n    };\\n\\n    // --- EVENT LISTENERS ---\\n    form.addEventListener('submit', handleGeneration);\\n\\n    // --- INIZIALIZZAZIONE ---\\n    await populateClasses();\\n    console.log(\"Modulo Lezioni (AI) caricato e configurato.\");\\n};\\n\\n// Avvia la configurazione non appena lo script viene eseguito\\nsetupLessons();\\n