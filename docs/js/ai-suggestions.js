\nconst setupSuggestions = async () => {\n\n    // --- CONTROLLO PREREQUISITI ---\n    if (!window.db || !firebase.auth().currentUser || !window.model) {\n        console.error('Requisiti non soddisfatti: Firestore, Utente o Modello AI non disponibili.');\n        document.getElementById('suggestions-result-container').innerHTML = \n            '<p class=\"error-message\">Errore: Impossibile inizializzare il modulo Suggerimenti.</p>';\n        return;\n    }\n\n    // --- ELEMENTI DEL DOM ---\n    const form = document.getElementById('suggestions-generator-form');\n    const classSelect = document.getElementById('suggestions-class-select');\n    const typeSelect = document.getElementById('suggestions-type-select');\n    const generateBtn = document.getElementById('generate-suggestions-btn');\n    const resultPlaceholder = document.getElementById('suggestions-result-placeholder');\n    const resultContent = document.getElementById('suggestions-result-content');\n    const resultLoader = document.getElementById('suggestions-result-loader');\n    const userId = firebase.auth().currentUser.uid;\n\n    // --- CARICAMENTO DATI DA FIRESTORE ---\n    let classes = [];\n    let students = [];\n    let evaluations = [];\n\n    try {\n        generateBtn.disabled = true;\n        const [classesSnap, studentsSnap, evalsSnap] = await Promise.all([\n            db.collection('users').doc(userId).collection('classes').get(),\n            db.collection('users').doc(userId).collection('students').get(),\n            db.collection('users').doc(userId).collection('evaluations').get()\n        ]);\n        classes = classesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\n        students = studentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\n        evaluations = evalsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\n        console.log(\"Dati per Suggerimenti IA caricati da Firestore.\");\n    } catch (error) {\n        console.error(\"Errore nel caricamento dati per Suggerimenti IA: \", error);\n        resultPlaceholder.innerHTML = '<p class=\"error-message\">Impossibile caricare i dati necessari.</p>';\n        return; // Blocca l'esecuzione ulteriore\n    } finally {\n        generateBtn.disabled = false;\n    }\n\n    // --- FUNZIONI ---\n    const populateClasses = () => {\n        classSelect.innerHTML = '<option value=\"\">-- Prima seleziona una classe --</option>';\n        classes.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {\n            const option = document.createElement('option');\n            option.value = c.id;\n            option.textContent = c.name;\n            classSelect.appendChild(option);\n        });\n    };\n\n    const handleGeneration = async (e) => {\n        e.preventDefault();\n        const classId = classSelect.value;\n        const type = typeSelect.value;\n        if (!classId) {\n            alert(\"Per favore, seleziona una classe da analizzare.\");\n            return;\n        }\n\n        resultPlaceholder.style.display = 'none';\n        resultContent.style.display = 'none';\n        resultLoader.style.display = 'block';\n        generateBtn.disabled = true;\n\n        // Dati pertinenti (usando classId come stringa per coerenza con Firestore)\n        const selectedClass = classes.find(c => c.id === classId);\n        const studentsInClass = students.filter(s => s.classId === classId);\n        const studentIds = studentsInClass.map(s => s.id);\n        const relevantEvaluations = evaluations.filter(ev => studentIds.includes(ev.studentId));\n\n        // Riassunto dati per IA\n        const dataSummary = studentsInClass.map(student => {\n            const studentEvals = relevantEvaluations.filter(ev => ev.studentId === student.id);\n            const grades = studentEvals.map(ev => parseFloat(ev.grade)).filter(g => !isNaN(g));\n            const average = grades.length > 0 ? (grades.reduce((a, b) => a + b, 0) / grades.length).toFixed(2) : 'N/A';\n            return { name: `${student.surname} ${student.name}`, average: average, gradeCount: grades.length };\n        });\n        \n        // Costruzione del prompt\n        const analysisType = document.querySelector(`#suggestions-type-select option[value=\"${type}\"]`).textContent;\n        let prompt = `Agisci come un esperto di pedagogia e didattica. Analizza i dati di rendimento della classe '${selectedClass.name}' e fornisci suggerimenti. Tipo di analisi: '${analysisType}'. Dati: ${JSON.stringify(dataSummary, null, 2)}. Richiesta: ${getPromptInstructions(type)}. Rispondi in Markdown ben formattato.`;\n\n        try {\n            const result = await window.model.generateContent(prompt);\n            const response = await result.response;\n            const text = await response.text();\n\n            // Semplice conversione da Markdown a HTML per la visualizzazione\n            resultContent.innerHTML = text\n                .replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>')\n                .replace(/^### (.*$)/gim, '<h3>$1</h3>')\n                .replace(/^## (.*$)/gim, '<h2>$1</h2>')\n                .replace(/^# (.*$)/gim, '<h1>$1</h1>')\n                .replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>')\n                .replace(/<\/ul>\n<ul>/g, '') // Unisce le liste\n                .replace(/\n/g, '<br />');\n            resultContent.style.display = 'block';\n\n        } catch (error) {\n            console.error(\"Errore generazione suggerimenti:\", error);\n            resultContent.innerHTML = '<p class=\"error-message\">Si è verificato un errore durante l\'analisi. Riprova.</p>';\n            resultContent.style.display = 'block';\n        } finally {\n            resultLoader.style.display = 'none';\n            generateBtn.disabled = false;\n        }\n    };\n    \n    const getPromptInstructions = (type) => {\n        switch(type) {\n            case 'identify_struggling': return \"Individua studenti in difficoltà (basse medie, poche valutazioni). Suggerisci cause e strategie di recupero personalizzate.\";\n            case 'identify_top_performers': return \"Individua studenti con ottime performance. Suggerisci attività di potenziamento per stimolarli ulteriormente.\";\n            case 'class_overview': return \"Fornisci una panoramica generale della classe, evidenziando punti di forza/debolezza e suggerendo strategie didattiche a livello di gruppo.\";\n            default: return \"Fornisci un\'analisi generale.\";\n        }\n    }\n\n    // --- EVENTI E INIZIALIZZAZIONE ---\n    form.addEventListener('submit', handleGeneration);\n    populateClasses();\n    console.log(\"Modulo Suggerimenti IA caricato.\");\n};\n\nsetupSuggestions();\n