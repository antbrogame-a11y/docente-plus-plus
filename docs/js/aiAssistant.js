\n// Funzione di setup per la sezione Assistente AI, caricata dinamicamente.\nconst setupAiAssistant = () => {\n\n    // Tenta di accedere agli oggetti globali di Firebase/Vertex\n    if (typeof model === 'undefined') {\n        console.error('Il modello AI (Gemini) non è inizializzato. Controlla la configurazione di Firebase in app.js.');\n        // Opzionalmente, mostra un messaggio di errore all'utente nell'interfaccia.\n        const chatWindow = document.getElementById('ai-chat-window');\n        if (chatWindow) {\n            chatWindow.innerHTML = '<div class=\"chat-message ai-error-message\">Impossibile comunicare con l\'assistente AI. La configurazione di Firebase non è stata caricata correttamente.</div>';\n        }\n        return;\n    }\n\n    // --- ELEMENTI DEL DOM ---\n    const chatWindow = document.getElementById('ai-chat-window');\n    const inputForm = document.getElementById('ai-input-form');\n    const promptInput = document.getElementById('ai-prompt-input');\n    const suggestionButtons = document.querySelectorAll('.btn-suggestion');\n\n    // --- FUNZIONI ---\n\n    const addMessageToChat = (message, sender) => {\n        const messageDiv = document.createElement('div');\n        messageDiv.className = `chat-message chat-message-${sender}`;
        \n        // Semplice parsing per grassetto e liste\n        let formattedMessage = message.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');\n        formattedMessage = formattedMessage.replace(/\* (.*)/g, '<ul><li>$1</li></ul>').replace(/<li>(.*)\n/g, '<li>$1</li>');\n\n        messageDiv.innerHTML = `<p>${formattedMessage}</p>`;\n        chatWindow.appendChild(messageDiv);\n\n        // Scrolla fino in fondo alla finestra della chat\n        chatWindow.scrollTop = chatWindow.scrollHeight;\n    };\n\n    const sendPrompt = async (e) => {\n        e.preventDefault();\n        const promptText = promptInput.value.trim();\n        if (!promptText) return;\n\n        addMessageToChat(promptText, 'user');\n        promptInput.value = '';\n\n        // Mostra l'indicatore di "sta pensando"\n        const thinkingIndicator = document.createElement('div');\n        thinkingIndicator.className = 'chat-message chat-message-ai thinking';\n        thinkingIndicator.innerHTML = '<p>...</p>';\n        chatWindow.appendChild(thinkingIndicator);\n        chatWindow.scrollTop = chatWindow.scrollHeight;\n\n        try {\n            const result = await model.generateContent(promptText);\n            const response = await result.response;\n            const text = await response.text();\n\n            // Rimuovi l'indicatore e aggiungi la risposta\n            chatWindow.removeChild(thinkingIndicator);\n            addMessageToChat(text, 'ai');\n\n        } catch (error) {\n            console.error("Errore durante la generazione dei contenuti dall'IA:", error);\n            chatWindow.removeChild(thinkingIndicator);\n            addMessageToChat('Spiacente, si è verificato un errore. Riprova più tardi.', 'ai-error-message');\n        }\n    };\n    \n    // --- EVENT LISTENER ---\n    inputForm.addEventListener('submit', sendPrompt);\n\n    suggestionButtons.forEach(button => {\n        button.addEventListener('click', () => {\n            promptInput.value = button.textContent;\n            promptInput.focus();\n        });\n    });\n\n};\n\n// Avvia la configurazione non appena lo script viene eseguito.\nsetupAiAssistant();\n